name: Cross-Platform Build

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  APP_NAME: yksoft
  APP_ID: org.freeradius.yksoft
  # fyne-cross uses module name for binary
  BINARY_NAME: yksofttoken

jobs:
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest

      - name: Build for Linux ${{ matrix.arch }}
        run: |
          fyne-cross linux -arch ${{ matrix.arch }} -app-id ${{ env.APP_ID }}

      - name: Find and prepare binary
        run: |
          echo "=== Looking for binary ==="
          find fyne-cross -type f 2>/dev/null || true
          mkdir -p dist
          # The binary is named after the module (yksofttoken)
          if [ -f "fyne-cross/bin/linux-${{ matrix.arch }}/${{ env.BINARY_NAME }}" ]; then
            cp "fyne-cross/bin/linux-${{ matrix.arch }}/${{ env.BINARY_NAME }}" dist/${{ env.APP_NAME }}
          fi
          ls -la dist/
          test -f "dist/${{ env.APP_NAME }}" || (echo "ERROR: Binary not found!" && exit 1)

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}
          path: dist/${{ env.APP_NAME }}
          if-no-files-found: error

  build-darwin:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build for macOS ${{ matrix.arch }}
        env:
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          fyne package -os darwin -appID "${{ env.APP_ID }}"

      - name: Prepare artifact
        run: |
          mkdir -p dist
          echo "=== Looking for .app bundles ==="
          find . -maxdepth 1 -name "*.app" -type d
          mv *.app dist/ 2>/dev/null || true
          # Rename to consistent name
          cd dist
          for app in *.app; do
            if [ "$app" != "${{ env.APP_NAME }}.app" ] && [ -d "$app" ]; then
              mv "$app" "${{ env.APP_NAME }}.app"
            fi
          done
          cd ..
          ls -la dist/

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-darwin-${{ matrix.arch }}
          path: dist/*.app
          if-no-files-found: error

  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest

      - name: Build for Windows ${{ matrix.arch }}
        run: |
          fyne-cross windows -arch ${{ matrix.arch }} -app-id ${{ env.APP_ID }}

      - name: Find and prepare binary
        run: |
          echo "=== Looking for exe ==="
          find fyne-cross -type f -name "*.exe" 2>/dev/null || true
          mkdir -p dist
          # Windows uses app name from FyneApp.toml which may have spaces
          EXE=$(find fyne-cross/bin/windows-${{ matrix.arch }} -name "*.exe" -type f | head -1)
          if [ -n "$EXE" ]; then
            echo "Found: $EXE"
            cp "$EXE" dist/${{ env.APP_NAME }}.exe
          fi
          ls -la dist/
          test -f "dist/${{ env.APP_NAME }}.exe" || (echo "ERROR: Exe not found!" && exit 1)

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-${{ matrix.arch }}
          path: dist/${{ env.APP_NAME }}.exe
          if-no-files-found: error

  build-windows-installer:
    name: Build Windows NSIS Installer
    needs: build-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-amd64
          path: nsis

      - name: List downloaded files
        run: |
          dir nsis\
        shell: cmd

      - name: Install NSIS
        run: choco install nsis -y

      - name: Create NSIS installer
        working-directory: nsis
        run: |
          dir
          & "${env:ProgramFiles(x86)}\NSIS\makensis.exe" installer.nsi
        shell: pwsh

      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-installer
          path: nsis/YKSoftToken-Setup.exe
          if-no-files-found: error

  build-deb:
    name: Build Debian Package
    needs: build-linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}
          path: artifact

      - name: List downloaded files
        run: |
          echo "=== Artifact contents ==="
          ls -laR artifact/

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev fakeroot

      - name: Build Debian package
        run: |
          VERSION=$(grep -oP 'Version = "\K[^"]+' FyneApp.toml || echo "1.0.0")
          PKG_NAME="${{ env.APP_NAME }}_${VERSION}_${{ matrix.arch }}"
          mkdir -p pkg/${PKG_NAME}/DEBIAN
          mkdir -p pkg/${PKG_NAME}/usr/bin
          mkdir -p pkg/${PKG_NAME}/usr/share/applications
          mkdir -p pkg/${PKG_NAME}/usr/share/icons/hicolor/256x256/apps
          
          # Find and copy binary
          BINARY=$(find artifact -type f | head -1)
          echo "Using binary: $BINARY"
          cp "$BINARY" pkg/${PKG_NAME}/usr/bin/${{ env.APP_NAME }}
          chmod 755 pkg/${PKG_NAME}/usr/bin/${{ env.APP_NAME }}
          
          # Create control file
          cat > pkg/${PKG_NAME}/DEBIAN/control << EOF
          Package: yksofttoken
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Arran Cudbard-Bell <a.cudbardb@freeradius.org>
          Description: Yubikey hardware token emulator
           Produces HOTP One Time Passcodes in Yubikey format, roughly
           following the behaviour of a hardware Yubikey. Useful for
           establishing M2M connections for VPNs which require 2FA.
          EOF
          
          # Create desktop entry
          cat > pkg/${PKG_NAME}/usr/share/applications/yksoft.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=YKSoft Token
          Comment=Yubikey software token emulator
          Exec=yksoft
          Icon=yksoft
          Categories=Utility;Security;
          Terminal=false
          EOF
          
          # Copy icon
          cp assets/icon.png pkg/${PKG_NAME}/usr/share/icons/hicolor/256x256/apps/yksoft.png
          
          # Build package
          dpkg-deb --build pkg/${PKG_NAME}
          mv pkg/${PKG_NAME}.deb .
          ls -la *.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-deb-${{ matrix.arch }}
          path: "*.deb"
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build-linux, build-darwin, build-windows, build-windows-installer, build-deb]
    runs-on: ubuntu-latest
    # Run on push to main/master (not PRs) or on tags
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP 'Version = "\K[^"]+' FyneApp.toml || echo "1.0.0")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          # For tagged releases, use the tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          else
            # For branch pushes, create a dev tag with short SHA
            SHORT_SHA=$(git rev-parse --short HEAD)
            TAG="v${VERSION}-dev-${SHORT_SHA}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}, Tag: ${TAG}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          ls -laR artifacts/
          
          # Linux binaries
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-linux-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-linux-${arch}
              chmod +x * 2>/dev/null || true
              tar -czvf ../../release/${{ env.APP_NAME }}-linux-${arch}.tar.gz *
              cd ../..
            fi
          done
          
          # macOS apps
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-darwin-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-darwin-${arch}
              zip -r ../../release/${{ env.APP_NAME }}-darwin-${arch}.zip *
              cd ../..
            fi
          done
          
          # Windows binaries
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-windows-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-windows-${arch}
              zip -r ../../release/${{ env.APP_NAME }}-windows-${arch}.zip *
              cd ../..
            fi
          done
          
          # Windows installer
          if [ -d "artifacts/${{ env.APP_NAME }}-windows-installer" ]; then
            cp artifacts/${{ env.APP_NAME }}-windows-installer/*.exe release/
          fi
          
          # Debian packages
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-deb-${arch}" ]; then
              cp artifacts/${{ env.APP_NAME }}-deb-${arch}/*.deb release/
            fi
          done
          
          echo "=== Release files ==="
          ls -la release/

      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: YKSoft Token ${{ steps.version.outputs.tag }}
          body: |
            ## YKSoft Token Release
            
            ### Downloads
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Windows | x64 | `yksoft-windows-amd64.zip` or `YKSoftToken-Setup.exe` |
            | Windows | ARM64 | `yksoft-windows-arm64.zip` |
            | macOS | Intel | `yksoft-darwin-amd64.zip` |
            | macOS | Apple Silicon | `yksoft-darwin-arm64.zip` |
            | Linux | x64 | `yksoft-linux-amd64.tar.gz` or `.deb` |
            | Linux | ARM64 | `yksoft-linux-arm64.tar.gz` or `.deb` |
            
            ### Installation
            
            **Windows:** Run `YKSoftToken-Setup.exe` or extract the ZIP and run `yksoft.exe`
            
            **macOS:** Extract the ZIP and move the `.app` to Applications
            
            **Linux (Debian/Ubuntu):** `sudo dpkg -i yksoft_*.deb`
            
            **Linux (Other):** Extract the tarball and run `./yksoft`
          files: release/*
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          generate_release_notes: true
