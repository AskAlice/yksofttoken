#!/usr/bin/make -f

DEB_VERSION = $(shell dpkg-parsechangelog --show-field Version)

export GOPROXY = https://proxy.golang.org,direct
export GO111MODULE = on

clean:
	rm -rf fyne-cross
	rm -rf debian/tmp
	go clean -cache || true

build: build-arch

binary: binary-arch

build-arch:
	go build -o yksoft ./cmd/yksoft

binary-arch:
	rm -rf debian/tmp
	mkdir -p debian/tmp/DEBIAN
	dpkg-gencontrol -pyksofttoken
	
	# Binary
	mkdir -p debian/tmp/usr/bin
	cp yksoft debian/tmp/usr/bin
	strip --strip-unneeded debian/tmp/usr/bin/yksoft || true
	
	# Desktop entry
	mkdir -p debian/tmp/usr/share/applications
	cat > debian/tmp/usr/share/applications/yksoft.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=YKSoft Token
Comment=Yubikey software token emulator
Exec=yksoft
Icon=yksoft
Categories=Utility;Security;
Terminal=false
EOF
	
	# Build package
	dpkg-deb --build debian/tmp ../yksofttoken_$(DEB_VERSION)_$(DEB_TARGET_ARCH).deb
