name: Cross-Platform Build

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'FyneApp.toml'
      - 'assets/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches:
      - master
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'FyneApp.toml'
      - 'assets/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

env:
  APP_NAME: yksoft
  APP_ID: org.freeradius.yksoft

jobs:
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest

      - name: Build for Linux ${{ matrix.arch }}
        run: |
          fyne-cross linux -arch ${{ matrix.arch }} -app-id ${{ env.APP_ID }} -name ${{ env.APP_NAME }} -debug

      - name: Find and prepare binary
        run: |
          echo "=== Full directory listing ==="
          find . -name "fyne-cross" -type d -exec find {} -type f \; 2>/dev/null || true
          echo "=== Looking for yksoft binary ==="
          find . -name "yksoft*" -type f 2>/dev/null || true
          echo "=== Preparing dist ==="
          mkdir -p dist
          # Try multiple possible locations
          for dir in "fyne-cross/bin/linux-${{ matrix.arch }}" "fyne-cross/dist/linux-${{ matrix.arch }}" "fyne-cross/bin" "fyne-cross/dist"; do
            if [ -f "${dir}/${{ env.APP_NAME }}" ]; then
              echo "Found binary at ${dir}/${{ env.APP_NAME }}"
              cp "${dir}/${{ env.APP_NAME }}" dist/
              break
            fi
          done
          # Fallback: find any yksoft binary
          if [ ! -f "dist/${{ env.APP_NAME }}" ]; then
            echo "Trying fallback search..."
            find . -path ./legacy -prune -o -name "${{ env.APP_NAME }}" -type f -print -quit | head -1 | xargs -I {} cp {} dist/ 2>/dev/null || true
          fi
          echo "=== dist contents ==="
          ls -la dist/ || echo "dist is empty"
          test -f "dist/${{ env.APP_NAME }}" || (echo "ERROR: Binary not found!" && exit 1)

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}
          path: dist/${{ env.APP_NAME }}
          if-no-files-found: error

  build-darwin:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build for macOS ${{ matrix.arch }}
        env:
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          fyne package -os darwin -name "${{ env.APP_NAME }}" -appID "${{ env.APP_ID }}"

      - name: Prepare artifact
        run: |
          mkdir -p dist
          echo "=== Looking for .app bundles ==="
          find . -maxdepth 1 -name "*.app" -type d
          mv *.app dist/ 2>/dev/null || true
          ls -la dist/

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-darwin-${{ matrix.arch }}
          path: dist/*.app
          if-no-files-found: error

  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest

      - name: Build for Windows ${{ matrix.arch }}
        run: |
          fyne-cross windows -arch ${{ matrix.arch }} -app-id ${{ env.APP_ID }} -name ${{ env.APP_NAME }} -debug

      - name: Find and prepare binary
        run: |
          echo "=== Full directory listing ==="
          find . -name "fyne-cross" -type d -exec find {} -type f \; 2>/dev/null || true
          echo "=== Looking for exe files ==="
          find . -name "*.exe" -type f 2>/dev/null || true
          echo "=== Preparing dist ==="
          mkdir -p dist
          # Try multiple possible locations
          for dir in "fyne-cross/bin/windows-${{ matrix.arch }}" "fyne-cross/dist/windows-${{ matrix.arch }}" "fyne-cross/bin" "fyne-cross/dist"; do
            if [ -f "${dir}/${{ env.APP_NAME }}.exe" ]; then
              echo "Found exe at ${dir}/${{ env.APP_NAME }}.exe"
              cp "${dir}/${{ env.APP_NAME }}.exe" dist/
              break
            fi
          done
          # Fallback: find any exe
          if [ ! -f "dist/${{ env.APP_NAME }}.exe" ]; then
            echo "Trying fallback search..."
            find . -name "${{ env.APP_NAME }}.exe" -type f -print -quit | head -1 | xargs -I {} cp {} dist/ 2>/dev/null || true
          fi
          echo "=== dist contents ==="
          ls -la dist/ || echo "dist is empty"
          test -f "dist/${{ env.APP_NAME }}.exe" || (echo "ERROR: Exe not found!" && exit 1)

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-${{ matrix.arch }}
          path: dist/${{ env.APP_NAME }}.exe
          if-no-files-found: error

  build-windows-installer:
    name: Build Windows NSIS Installer
    needs: build-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-amd64
          path: nsis

      - name: List downloaded files
        run: dir nsis\
        shell: cmd

      - name: Install NSIS
        run: choco install nsis -y

      - name: Create NSIS installer
        working-directory: nsis
        run: |
          dir
          & "${env:ProgramFiles(x86)}\NSIS\makensis.exe" installer.nsi
        shell: pwsh

      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-installer
          path: nsis/YKSoftToken-Setup.exe
          if-no-files-found: error

  build-deb:
    name: Build Debian Package
    needs: build-linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}
          path: dist

      - name: List downloaded files
        run: |
          echo "=== Downloaded files ==="
          ls -la dist/

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev fakeroot

      - name: Build Debian package
        run: |
          # Create package structure
          VERSION=$(grep -oP 'Version = "\K[^"]+' FyneApp.toml || echo "1.0.0")
          PKG_NAME="${{ env.APP_NAME }}_${VERSION}_${{ matrix.arch }}"
          mkdir -p pkg/${PKG_NAME}/DEBIAN
          mkdir -p pkg/${PKG_NAME}/usr/bin
          mkdir -p pkg/${PKG_NAME}/usr/share/applications
          mkdir -p pkg/${PKG_NAME}/usr/share/icons/hicolor/256x256/apps
          
          # Copy binary
          cp dist/${{ env.APP_NAME }} pkg/${PKG_NAME}/usr/bin/
          chmod 755 pkg/${PKG_NAME}/usr/bin/${{ env.APP_NAME }}
          
          # Create control file
          cat > pkg/${PKG_NAME}/DEBIAN/control << EOF
          Package: yksofttoken
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Arran Cudbard-Bell <a.cudbardb@freeradius.org>
          Description: Yubikey hardware token emulator
           Produces HOTP One Time Passcodes in Yubikey format, roughly
           following the behaviour of a hardware Yubikey. Useful for
           establishing M2M connections for VPNs which require 2FA.
          EOF
          
          # Create desktop entry
          cat > pkg/${PKG_NAME}/usr/share/applications/yksoft.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=YKSoft Token
          Comment=Yubikey software token emulator
          Exec=yksoft
          Icon=yksoft
          Categories=Utility;Security;
          Terminal=false
          EOF
          
          # Copy icon
          cp assets/icon.png pkg/${PKG_NAME}/usr/share/icons/hicolor/256x256/apps/yksoft.png
          
          # Build package
          dpkg-deb --build pkg/${PKG_NAME}
          mv pkg/${PKG_NAME}.deb .

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-deb-${{ matrix.arch }}
          path: "*.deb"
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build-linux, build-darwin, build-windows, build-windows-installer, build-deb]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          ls -la artifacts/
          
          # Linux
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-linux-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-linux-${arch}
              tar -czvf ../../release/${{ env.APP_NAME }}-linux-${arch}.tar.gz *
              cd ../..
            fi
          done
          
          # macOS
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-darwin-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-darwin-${arch}
              zip -r ../../release/${{ env.APP_NAME }}-darwin-${arch}.zip *
              cd ../..
            fi
          done
          
          # Windows
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-windows-${arch}" ]; then
              cd artifacts/${{ env.APP_NAME }}-windows-${arch}
              zip -r ../../release/${{ env.APP_NAME }}-windows-${arch}.zip *
              cd ../..
            fi
          done
          
          # Windows installer
          if [ -d "artifacts/${{ env.APP_NAME }}-windows-installer" ]; then
            cp artifacts/${{ env.APP_NAME }}-windows-installer/*.exe release/
          fi
          
          # Debian packages
          for arch in amd64 arm64; do
            if [ -d "artifacts/${{ env.APP_NAME }}-deb-${arch}" ]; then
              cp artifacts/${{ env.APP_NAME }}-deb-${arch}/*.deb release/
            fi
          done
          
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
